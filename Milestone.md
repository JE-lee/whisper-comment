### **开发计划 - 轻语评论 (WhisperComment)**

#### **阶段 0: 项目基础设置与环境准备 (Foundation)**

此阶段的目标是搭建好项目骨架，为后续功能开发铺平道路。

*   **任务 0.1: 服务端框架搭建**
    *   **描述**: 在 `packages/server` 中，安装 Fastify, TypeScript, ts-node-dev, 和 Prisma 等核心依赖。
    *   **状态**: `已完成`
*   **任务 0.2: 数据库模式初始化**
    *   **描述**: 根据技术设计文档，在 `packages/server/prisma/` 目录下创建 `schema.prisma` 文件，并定义 `sites`, `comments`, `push_subscriptions`, `did_associations` 等数据模型。
    *   **状态**: `已完成`
*   **任务 0.3: 数据库与缓存服务连接**
    *   **描述**: 注册并配置 Neon (PostgreSQL) 和 Upstash (Redis) 的免费服务。将连接凭证作为环境变量（例如，在 `.env` 文件中）配置到 `server` 项目中。
    *   **状态**: `未开始`
*   **任务 0.4: 客户端基础设置**
    *   **描述**: 确认 `packages/client` 中的 Preact 和 Vite 环境正常工作，并安装 `axios` 或 `fetch` 用于API请求。
    *   **状态**: `已部分完成` (项目已初始化)

---

#### **阶段 1: V1.0 - 最小可行产品 (MVP)**

此阶段的目标是上线产品的核心功能：匿名评论和实时通知。

*   **任务 1.1 (后端): 评论API - 创建与读取**
    *   **描述**: 开发 `POST /api/v1/comments` 用于接收新评论，并开发 `GET /api/v1/comments` 用于拉取指定页面的评论列表。
    *   **状态**: `未开始`
*   **任务 1.2 (前端): 核心UI - 评论框与列表**
    *   **描述**: 在客户端实现评论输入框（昵称、内容）和评论列表的UI组件。实现 `localStorage` 中的 `userToken` 生成与管理逻辑。
    *   **状态**: `未开始`
*   **任务 1.3 (前端): API集成 - 提交与展示**
    *   **描述**: 实现前端逻辑，调用后端API来提交新评论，并拉取、渲染评论列表。
    *   **状态**: `未开始`
*   **任务 1.4 (后端): 实时通知 - WebSocket基础**
    *   **描述**: 使用 `@fastify/websocket` 搭建WebSocket服务，实现客户端连接时基于 `userToken` 的身份关联（可使用Redis存储映射关系）。
    *   **状态**: `未开始`
*   **任务 1.5 (后端): 实时通知 - 消息推送**
    *   **描述**: 当有新回复产生时，通过Redis Pub/Sub等机制，通知WebSocket服务向被回复者推送实时消息。
    *   **状态**: `未开始`
*   **任务 1.6 (前端): 实时通知 - 接收与展示**
    *   **描述**: 实现客户端WebSocket连接逻辑，接收到新回复通知后，在UI上给出实时反馈（如高亮新评论）。
    *   **状态**: `未开始`
*   **任务 1.7 (后端): 基础管理与反垃圾**
    *   **描述**: 开发基础的评论管理API（审核、删除），并实现一个简单的关键词黑名单过滤功能。
    *   **状态**: `未开始`
*   **任务 1.8 (部署): CI/CD 部署流程**
    *   **描述**: 按照技术文档，配置Vercel用于自动部署后端服务，配置Cloudflare Pages用于自动部署前端脚本。
    *   **状态**: `未开始`

---

#### **阶段 2: V1.1 - 体验增强**

*   **任务 2.1 (后端): API - 评论编辑与删除**
    *   **描述**: 开发 `PUT /comments/:id` 和 `DELETE /comments/:id` 接口，并加入基于 `userToken` 和时间的权限校验。
    *   **状态**: `未开始`
*   **任务 2.2 (前端): UI - 评论编辑与删除**
    *   **描述**: 为用户自己的评论添加编辑和删除按钮，并开发相应的交互界面。
    *   **状态**: `未开始`
*   **任务 2.3 (全端): 富文本支持**
    *   **描述**: 后端引入 `sanitize-html` 防止XSS，前端引入 `marked` 等库将Markdown格式的评论内容渲染为HTML。
    *   **状态**: `未开始`
*   **任务 2.4 (后端): 浏览器推送 - 订阅存储**
    *   **描述**: 开发 `POST /subscribe` 接口，用于存储用户授权后的浏览器PushSubscription信息。
    *   **状态**: `未开始`
*   **任务 2.5 (全端): 浏览器推送 - 实现**
    *   **描述**: 前端实现获取推送授权的逻辑；后端使用 `web-push` 库在产生新回复时发送离线通知。
    *   **状态**: `未开始`

---

#### **阶段 3: V1.2 - SaaS价值深化**

此阶段的目标是为SaaS客户提供更多价值，提升产品的商业吸引力。

*   **任务 3.1 (后端): 站长API - 基础分析**
    *   **描述**: 开发API端点，用于提供基础数据分析，如评论数趋势、热门讨论页面等。
    *   **状态**: `未开始`
*   **任务 3.2 (前端): 站长仪表盘 - 数据展示**
    *   **描述**: 开发一个简单的管理后台页面，用于可视化展示任务3.1中API提供的数据。
    *   **状态**: `未开始`
*   **任务 3.3 (后端): 站长API - 外观定制**
    *   **描述**: 扩展 `sites` 表的 `settings` 字段，并开发API允许站长修改评论区的主题（明/暗）、主色调等。
    *   **状态**: `未开始`
*   **任务 3.4 (前端): 站长仪表盘 - 外观设置**
    *   **描述**: 在管理后台页面中，提供UI控件让站长可以方便地进行外观定制并保存。
    *   **状态**: `未开始`
*   **任务 3.5 (前端): 客户端加载定制化外观**
    *   **描述**: 客户端 `embed.js` 在初始化时，从后端获取并应用站长自定义的外观配置。
    *   **状态**: `未开始`

---

#### **阶段 4: V2.0 - 未来愿景启动**

此阶段将引入Web3元素，实现面向未来的去中心化身份系统。

*   **任务 4.1 (后端): DID身份关联 - API**
    *   **描述**: 开发 `POST /identities/connect-did` 接口。接口需要接收用户的 `user_token`、公钥地址和签名，并验证签名的有效性，然后将 `did_address` 与 `author_token` 存入 `did_associations` 表。
    *   **状态**: `未开始`
*   **任务 4.2 (前端): 数字钱包连接**
    *   **描述**: 在评论区提供“[ ✨ 使用数字身份连接 ]”选项。集成 `ethers.js` 或类似库，实现连接MetaMask等钱包、获取用户地址并发起签名请求的功能。
    *   **状态**: `未开始`
*   **任务 4.3 (全端): 已验证身份展示**
    *   **描述**: 对于使用DID连接的用户，在评论区其昵称旁显示一个特殊的认证徽章，并将其DID地址作为其跨站的唯一标识符。
    *   **状态**: `未开始`